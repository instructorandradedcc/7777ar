<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ecobook AR</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- MindAR para A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        /* Estilos para la interfaz de escaneo (no utilizada pero disponible) */
        #scanning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            z-index: 10000;
        }
        .scanning-box {
            border: 4px solid white;
            border-radius: 12px;
            width: 250px;
            height: 250px;
            position: relative;
        }
        .scanning-text {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="fixed inset-0 z-30 flex flex-col justify-center items-center text-center bg-gradient-to-br from-indigo-600 to-purple-800 text-white p-6 transition-opacity duration-500 ease-in-out">
        <img src="https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/logofundacion.jpg" alt="Logo Fundación" class="h-24 mb-6 rounded-xl shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/96x96/e2e8f0/94a3b8?text=Logo';">
        <h1 class="text-4xl font-bold mb-2">Ecobook AR</h1>
        <p class="text-lg max-w-md mb-8">Presiona el botón para activar tu cámara y apunta hacia las imágenes del libro para darles vida.</p>
        <button id="start-ar-btn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition duration-300 shadow-xl text-lg flex items-center">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            Iniciar Experiencia
        </button>
    </div>

    <!-- Contenedor para la Escena AR (inicialmente vacío) -->
    <div id="ar-scene-container" class="fixed inset-0 z-10"></div>
    
    <!-- Controles cuando la AR está activa -->
    <div id="ar-active-controls" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 z-20">
         <button id="stop-ar-btn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-full hover:bg-red-600 transition duration-300 shadow-xl">Detener Cámara</button>
    </div>

    <!-- Pantalla de Error (en lugar de 'alert') -->
    <div id="error-screen" class="hidden fixed inset-0 z-40 flex flex-col justify-center items-center text-center bg-black bg-opacity-70 text-white p-6">
        <h2 class="text-2xl font-bold mb-4">¡Oops! Algo salió mal</h2>
        <p id="error-message" class="max-w-md mb-6">No se pudo iniciar la cámara. Asegúrate de haber otorgado los permisos necesarios en tu navegador e inténtalo de nuevo.</p>
        <button id="close-error-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600 transition duration-300">Entendido</button>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- COMPONENTE A-FRAME PARA INTERACCIÓN TÁCTIL (Sin cambios) ---
        AFRAME.registerComponent('target-interaction', {
            init: function () {
                this.model = null;
                this.pinching = false;
                this.rotating = false;
                this.initialPinchDistance = 0;
                this.lastTouchPosition = { x: 0, y: 0 };
                
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchMove = this.onTouchMove.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);

                this.el.addEventListener('targetFound', () => {
                    this.model = this.el.querySelector('a-gltf-model');
                    if (this.model) {
                        this.el.sceneEl.canvas.addEventListener('touchstart', this.onTouchStart);
                        this.el.sceneEl.canvas.addEventListener('touchmove', this.onTouchMove);
                        this.el.sceneEl.canvas.addEventListener('touchend', this.onTouchEnd);
                    }
                });

                this.el.addEventListener('targetLost', () => {
                    if (this.model) {
                        this.el.sceneEl.canvas.removeEventListener('touchstart', this.onTouchStart);
                        this.el.sceneEl.canvas.removeEventListener('touchmove', this.onTouchMove);
                        this.el.sceneEl.canvas.removeEventListener('touchend', this.onTouchEnd);
                    }
                    this.model = null;
                });
            },
            
            onTouchStart: function (evt) {
                if (!this.model) return;
                evt.preventDefault();
                if (evt.touches.length === 1) {
                    this.rotating = true;
                    this.lastTouchPosition = { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
                } else if (evt.touches.length === 2) {
                    this.rotating = false;
                    this.pinching = true;
                    this.initialPinchDistance = this.getDistance(evt.touches[0], evt.touches[1]);
                    this.initialScale = this.model.object3D.scale.clone();
                }
            },

            onTouchMove: function (evt) {
                if (!this.model) return;
                evt.preventDefault();
                if (this.rotating && evt.touches.length === 1) {
                    const touch = evt.touches[0];
                    const dx = touch.clientX - this.lastTouchPosition.x;
                    const dy = touch.clientY - this.lastTouchPosition.y;
                    this.model.object3D.rotation.y += dx * 0.01;
                    this.model.object3D.rotation.x += dy * 0.01;
                    this.lastTouchPosition = { x: touch.clientX, y: touch.clientY };
                } else if (this.pinching && evt.touches.length === 2) {
                    const currentPinchDistance = this.getDistance(evt.touches[0], evt.touches[1]);
                    if (this.initialPinchDistance === 0) return;
                    const scaleFactor = currentPinchDistance / this.initialPinchDistance;
                    const newScale = this.initialScale.clone().multiplyScalar(scaleFactor);
                    this.model.object3D.scale.copy(newScale);
                }
            },

            onTouchEnd: function (evt) {
                if (!this.model) return;
                if (evt.touches.length < 2) this.pinching = false;
                if (evt.touches.length < 1) this.rotating = false;
            },

            getDistance: function (t1, t2) {
                const dx = t1.clientX - t2.clientX;
                const dy = t1.clientY - t2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        });

        // --- ESTADO Y CONSTANTES ---
        const state = {
            isArActive: false,
            assets: [],
        };
        
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/';
        const MARKERS_URL = `${GITHUB_BASE_URL}markers/`;
        const MODELS_URL = `${GITHUB_BASE_URL}modelss/`;


        const ASSETS_CONFIG = [
            { name: 'botellytaazul', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
            { name: 'ecoladrillo', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
            { name: 'lataplateada', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
            { name: 'papelitoverde', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
            { name: 'senorcontenedor', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
            { name: 'taparoja', scale: 0.5, position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 } },
        ];

        state.assets = ASSETS_CONFIG.map((config, index) => ({
            id: index,
            markerUrl: `${MARKERS_URL}${config.name}.mind`,
            modelUrl: `${MODELS_URL}${config.name}.glb`,
            transform: config
        }));
        
        // --- Elementos del DOM ---
        const startBtn = document.getElementById('start-ar-btn');
        const stopBtn = document.getElementById('stop-ar-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const arSceneContainer = document.getElementById('ar-scene-container');
        const arActiveControls = document.getElementById('ar-active-controls');
        const errorScreen = document.getElementById('error-screen');
        const errorMessage = document.getElementById('error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');

        // --- FUNCIONES DE LA APLICACIÓN ---
        
        function startAR() {
            startBtn.disabled = true;
            startBtn.textContent = "Cargando...";
            welcomeScreen.classList.add('opacity-0', 'pointer-events-none');
            
            const sceneEl = document.createElement('a-scene');
            
            const markerUrlList = state.assets.map(asset => asset.markerUrl).join(';');
            
            // SOLUCIÓN: Cambiar autoStart a 'false' para iniciar la cámara manualmente.
            sceneEl.setAttribute('mindar-image', `imageTargetSrc: ${markerUrlList}; autoStart: false; uiLoading: yes; uiError: no; uiScanning: no;`);
            sceneEl.setAttribute('color-space', 'sRGB');
            sceneEl.setAttribute('renderer', 'colorManagement: true, physicallyCorrectLights: true');
            sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
            sceneEl.setAttribute('device-orientation-permission-ui', 'enabled: false');
            sceneEl.setAttribute('embedded', '');

            const assetsEl = document.createElement('a-assets');
            state.assets.forEach(asset => {
                const assetItem = document.createElement('a-asset-item');
                assetItem.setAttribute('id', `model-${asset.id}`);
                assetItem.setAttribute('src', asset.modelUrl);
                assetsEl.appendChild(assetItem);
            });
            sceneEl.appendChild(assetsEl);

            const cameraEl = document.createElement('a-camera');
            cameraEl.setAttribute('position', '0 0 0');
            cameraEl.setAttribute('look-controls', 'enabled: false');
            sceneEl.appendChild(cameraEl);

            state.assets.forEach((asset, index) => {
                const targetEl = document.createElement('a-entity');
                targetEl.setAttribute('mindar-image-target', `targetIndex: ${index}`);
                targetEl.setAttribute('target-interaction', '');

                const modelEntity = document.createElement('a-gltf-model');
                const t = asset.transform;
                modelEntity.setAttribute('src', `#model-${asset.id}`);
                modelEntity.setAttribute('position', `${t.position.x} ${t.position.y} ${t.position.z}`);
                modelEntity.setAttribute('rotation', `${t.rotation.x} ${t.rotation.y} ${t.rotation.z}`);
                modelEntity.setAttribute('scale', `${t.scale} ${t.scale} ${t.scale}`);
                modelEntity.setAttribute('animation-mixer', '');
                
                targetEl.appendChild(modelEntity);
                sceneEl.appendChild(targetEl);
            });

            // SOLUCIÓN: Añadir un listener que espera a que la escena se cargue para iniciar la cámara.
            // Esto asegura que la solicitud de permiso esté directamente vinculada a la acción del usuario.
            sceneEl.addEventListener('loaded', () => {
                sceneEl.systems['mindar-image'].start();
            });

            sceneEl.addEventListener('arReady', () => {
                arActiveControls.classList.remove('hidden');
                state.isArActive = true;
            });

            sceneEl.addEventListener('arError', (event) => {
                console.error("Error al iniciar MindAR:", event.detail);
                let message = "No se pudo iniciar la cámara. Por favor, asegúrate de haberle dado permisos y vuelve a intentarlo.";
                if (event.detail && event.detail.name === 'NotFoundError') {
                    message = "No se encontró una cámara compatible en tu dispositivo.";
                } else if (event.detail && event.detail.name === 'NotAllowedError') {
                    message = "El permiso para acceder a la cámara fue denegado. Debes permitirlo en la configuración de tu navegador para continuar.";
                }
                showError(message);
                stopAR(); // Limpiar la escena fallida
            });

            arSceneContainer.appendChild(sceneEl);
        }

        function stopAR() {
            const sceneEl = arSceneContainer.querySelector('a-scene');
            if (sceneEl) {
                if (sceneEl.systems['mindar-image']) {
                    sceneEl.systems['mindar-image'].stop();
                }
                if (sceneEl.parentNode) {
                    sceneEl.parentNode.removeChild(sceneEl);
                }
            }
            arSceneContainer.innerHTML = '';
            
            welcomeScreen.classList.remove('opacity-0', 'pointer-events-none');
            arActiveControls.classList.add('hidden');
            startBtn.disabled = false;
            startBtn.innerHTML = '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Iniciar Experiencia';
            state.isArActive = false;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorScreen.classList.remove('hidden');
        }

        function hideError() {
            errorScreen.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', startAR);
        stopBtn.addEventListener('click', stopAR);
        closeErrorBtn.addEventListener('click', hideError);
    });
    </script>
</body>
</html>




