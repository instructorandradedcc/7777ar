<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ecobook AR</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- MindAR para A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        /* Estilos adicionales para asegurar que la escena no interfiera cuando está oculta */
        #ar-scene-container a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Animación para el spinner de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">

    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="fixed inset-0 z-30 flex flex-col justify-center items-center text-center bg-gradient-to-br from-indigo-600 to-purple-800 text-white p-6 transition-opacity duration-500 ease-in-out">
        <img src="https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/logofundacion.jpg" alt="Logo Fundación" class="h-24 mb-6 rounded-xl shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/96x96/e2e8f0/94a3b8?text=Logo';">
        <h1 class="text-4xl font-bold mb-2">Ecobook AR</h1>
        <p class="text-lg max-w-md mb-8">Presiona el botón para activar tu cámara y apunta hacia las imágenes del libro para darles vida.</p>
        
        <!-- Botón con estado de carga claro -->
        <button id="start-ar-btn" class="bg-gray-400 text-white font-bold py-3 px-8 rounded-full shadow-xl text-lg flex items-center justify-center cursor-not-allowed" disabled>
            <span id="button-spinner" class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-3"></span>
            <span id="button-text">Cargando</span>
        </button>
        <p id="loading-details" class="mt-4 text-sm text-gray-200">Descargando paquetes para la experiencia...</p>
    </div>

    <!-- Pantalla de Carga Intermedia -->
    <div id="loading-screen" class="hidden fixed inset-0 z-50 flex flex-col justify-center items-center text-center bg-gray-900 bg-opacity-90 text-white p-6">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <h2 class="text-2xl font-bold mb-2">Preparando la Experiencia</h2>
        <p class="max-w-md">Por favor, acepta el permiso para usar la cámara cuando tu navegador lo solicite.</p>
    </div>

    <!-- Contenedor para la Escena AR -->
    <div id="ar-scene-container" class="fixed inset-0 z-10">
        <a-scene id="ar-scene" style="display: none;"
            color-space="sRGB"
            renderer="colorManagement: true, physicallyCorrectLights"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false">
            
            <a-assets id="ar-assets" timeout="60000"></a-assets>
            
            <a-entity light="type: ambient; color: #BBB"></a-entity>
            <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>
    </div>
    
    <!-- Controles cuando la AR está activa -->
    <div id="ar-active-controls" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 z-20">
         <button id="stop-ar-btn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-full hover:bg-red-600 transition duration-300 shadow-xl">Detener Cámara</button>
    </div>

    <!-- Pantalla de Error -->
    <div id="error-screen" class="hidden fixed inset-0 z-40 flex flex-col justify-center items-center text-center bg-black bg-opacity-70 text-white p-6">
        <h2 class="text-2xl font-bold mb-4">¡Oops! Algo salió mal</h2>
        <p id="error-message" class="max-w-md mb-6"></p>
        <button id="close-error-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600 transition duration-300">Entendido</button>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        AFRAME.registerComponent('target-interaction', {
            init: function () {
                this.model = null; this.pinching = false; this.rotating = false;
                this.initialPinchDistance = 0; this.lastTouchPosition = { x: 0, y: 0 };
                this.onTouchStart = this.onTouchStart.bind(this); this.onTouchMove = this.onTouchMove.bind(this); this.onTouchEnd = this.onTouchEnd.bind(this);
                this.el.addEventListener('targetFound', () => {
                    this.model = this.el.querySelector('a-gltf-model');
                    if (this.model) {
                        const canvas = this.el.sceneEl.canvas;
                        canvas.addEventListener('touchstart', this.onTouchStart); canvas.addEventListener('touchmove', this.onTouchMove); canvas.addEventListener('touchend', this.onTouchEnd);
                    }
                });
                this.el.addEventListener('targetLost', () => {
                    if (this.model) {
                        const canvas = this.el.sceneEl.canvas;
                        canvas.removeEventListener('touchstart', this.onTouchStart); canvas.removeEventListener('touchmove', this.onTouchMove); canvas.removeEventListener('touchend', this.onTouchEnd);
                    }
                    this.model = null;
                });
            },
            onTouchStart: function (evt) {
                if (!this.model) return; evt.preventDefault();
                if (evt.touches.length === 1) { this.rotating = true; this.lastTouchPosition = { x: evt.touches[0].clientX, y: evt.touches[0].clientY }; } 
                else if (evt.touches.length === 2) { this.rotating = false; this.pinching = true; this.initialPinchDistance = this.getDistance(evt.touches[0], evt.touches[1]); this.initialScale = this.model.object3D.scale.clone(); }
            },
            onTouchMove: function (evt) {
                if (!this.model) return; evt.preventDefault();
                if (this.rotating && evt.touches.length === 1) { const touch = evt.touches[0]; const dx = touch.clientX - this.lastTouchPosition.x; const dy = touch.clientY - this.lastTouchPosition.y; this.model.object3D.rotation.y += dx * 0.01; this.model.object3D.rotation.x += dy * 0.01; this.lastTouchPosition = { x: touch.clientX, y: touch.clientY }; } 
                else if (this.pinching && evt.touches.length === 2) { const currentPinchDistance = this.getDistance(evt.touches[0], evt.touches[1]); if (this.initialPinchDistance === 0) return; const scaleFactor = currentPinchDistance / this.initialPinchDistance; const newScale = this.initialScale.clone().multiplyScalar(scaleFactor); this.model.object3D.scale.copy(newScale); }
            },
            onTouchEnd: function (evt) { if (!this.model) return; if (evt.touches.length < 2) this.pinching = false; if (evt.touches.length < 1) this.rotating = false; },
            getDistance: function (t1, t2) { const dx = t1.clientX - t2.clientX; const dy = t1.clientY - t2.clientY; return Math.sqrt(dx * dx + dy * dy); }
        });

        const state = { isArActive: false, assets: [], };
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/';
        const ASSETS_CONFIG = [
            { name: 'botellytaazul', scale: 0.5 }, { name: 'ecoladrillo', scale: 0.5 }, { name: 'lataplateada', scale: 0.5 },
            { name: 'papelitoverde', scale: 0.5 }, { name: 'senorcontenedor', scale: 0.5 }, { name: 'taparoja', scale: 0.5 },
        ];
        state.assets = ASSETS_CONFIG.map((config, index) => ({
            id: index,
            markerUrl: `${GITHUB_BASE_URL}markers/${config.name}.mind`,
            modelUrl: `${GITHUB_BASE_URL}modelss/${config.name}.glb`,
            transform: { position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 }, scale: config.scale }
        }));
        
        const startBtn = document.getElementById('start-ar-btn');
        const buttonSpinner = document.getElementById('button-spinner');
        const buttonText = document.getElementById('button-text');
        const loadingDetails = document.getElementById('loading-details');
        const stopBtn = document.getElementById('stop-ar-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const arSceneEl = document.getElementById('ar-scene');
        const arAssetsEl = document.getElementById('ar-assets');
        const arActiveControls = document.getElementById('ar-active-controls');
        const errorScreen = document.getElementById('error-screen');
        const errorMessage = document.getElementById('error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');

        let areAssetsLoaded = false;
        let isMindARReady = false;

        function checkIfReady() {
            if (areAssetsLoaded && isMindARReady) {
                console.log("Todos los recursos Y la escena están listos.");
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                startBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                buttonSpinner.style.display = 'none';
                buttonText.textContent = 'Iniciar Experiencia';
                loadingDetails.textContent = '¡Todo listo!';
                setTimeout(() => { loadingDetails.style.display = 'none'; }, 2000);
            }
        }

        async function configureMindAR() {
            try {
                console.log("Descargando marcadores para crear URLs seguras...");
                const markerBlobUrls = await Promise.all(
                    state.assets.map(async (asset) => {
                        const response = await fetch(asset.markerUrl);
                        if (!response.ok) throw new Error(`Fallo al descargar: ${asset.markerUrl}`);
                        const blob = await response.blob();
                        return URL.createObjectURL(blob);
                    })
                );
                console.log("URLs de marcadores seguras creadas.");

                const markerUrlList = markerBlobUrls.join(';');
                const mindarImageProps = `imageTargetSrc: ${markerUrlList}; autoStart: false; uiLoading: no; uiError: no; uiScanning: no;`;
                arSceneEl.setAttribute('mindar-image', mindarImageProps);
                
                isMindARReady = true;
                checkIfReady();

            } catch (err) {
                console.error("Fallo en la configuración de MindAR:", err);
                showError("Error al preparar los marcadores AR. Revisa tu conexión o los archivos.");
            }
        }

        function setupSceneContent() {
            state.assets.forEach(asset => {
                const assetItem = document.createElement('a-asset-item');
                assetItem.setAttribute('id', `model-${asset.id}`);
                assetItem.setAttribute('src', asset.modelUrl);
                arAssetsEl.appendChild(assetItem);
            });
            
            state.assets.forEach((asset, index) => {
                const targetEl = document.createElement('a-entity');
                targetEl.setAttribute('mindar-image-target', `targetIndex: ${index}`);
                targetEl.setAttribute('target-interaction', '');
                const t = asset.transform;
                const modelEntity = document.createElement('a-gltf-model');
                modelEntity.setAttribute('src', `#model-${asset.id}`);
                modelEntity.setAttribute('position', `${t.position.x} ${t.position.y} ${t.position.z}`);
                modelEntity.setAttribute('rotation', `${t.rotation.x} ${t.rotation.y} ${t.rotation.z}`);
                modelEntity.setAttribute('scale', `${t.scale} ${t.scale} ${t.scale}`);
                modelEntity.setAttribute('animation-mixer', '');
                targetEl.appendChild(modelEntity);
                arSceneEl.appendChild(targetEl);
            });

            arSceneEl.addEventListener('arReady', () => {
                loadingScreen.classList.add('hidden');
                arActiveControls.classList.remove('hidden');
                state.isArActive = true;
            });

            arSceneEl.addEventListener('arError', (event) => {
                console.error("Error al iniciar MindAR:", event.detail);
                let message = "No se pudo iniciar la cámara. Asegúrate de haberle dado permisos y vuelve a intentarlo.";
                if (event.detail?.name === 'NotFoundError') { message = "No se encontró una cámara compatible en tu dispositivo."; }
                if (event.detail?.name === 'NotAllowedError') { message = "Permiso a la cámara denegado. Habilítalo en tu navegador."; }
                showError(message);
                stopAR();
            });

            // SOLUCIÓN: Esperar a que la escena esté cargada para configurar MindAR
            if (arSceneEl.hasLoaded) {
                console.log("La escena A-Frame ya estaba cargada.");
                configureMindAR();
            } else {
                arSceneEl.addEventListener('loaded', () => {
                    console.log("La escena A-Frame ha sido cargada y está lista.");
                    configureMindAR();
                });
            }
        }
        
        async function startAR() {
            startBtn.disabled = true;
            welcomeScreen.classList.add('opacity-0', 'pointer-events-none');
            loadingScreen.classList.remove('hidden');

            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                const mindarSystem = arSceneEl.systems['mindar-image'];
                if (!mindarSystem || typeof mindarSystem.start !== 'function') {
                    throw new Error("El sistema MindAR no se inicializó correctamente. Por favor, refresca la página.");
                }
                await mindarSystem.start();
                arSceneEl.style.display = 'block';
            } catch (err) {
                console.error("Fallo al iniciar AR:", err);
                showError(err.message || "No se pudo iniciar la cámara. Revisa los permisos e inténtalo de nuevo.");
            }
        }

        function stopAR() {
            if (state.isArActive) {
                const mindarSystem = arSceneEl.systems['mindar-image'];
                if (mindarSystem && mindarSystem.isScanning) { mindarSystem.stop(); }
            }
            arSceneEl.style.display = 'none';
            loadingScreen.classList.add('hidden');
            welcomeScreen.classList.remove('opacity-0', 'pointer-events-none');
            arActiveControls.classList.add('hidden');
            state.isArActive = false;
            
            if (areAssetsLoaded && isMindARReady) {
                startBtn.disabled = false;
                checkIfReady();
            }
        }
        
        function showError(message) {
            loadingScreen.classList.add('hidden');
            errorMessage.textContent = message;
            errorScreen.classList.remove('hidden');
        }

        function hideError() {
            errorScreen.classList.add('hidden');
            stopAR();
        }
        
        arAssetsEl.addEventListener('loaded', () => {
            console.log("Todos los recursos AR (modelos) han sido cargados.");
            areAssetsLoaded = true;
            checkIfReady();
        });
        arAssetsEl.addEventListener('timeout', () => {
            console.error("La carga de recursos ha superado el tiempo de espera.");
            showError("La carga de los modelos 3D tardó demasiado. Revisa tu conexión a internet e inténtalo de nuevo.");
        });

        // Iniciar la configuración
        setupSceneContent();
        
        // Listeners de botones
        startBtn.addEventListener('click', startAR);
        stopBtn.addEventListener('click', stopAR);
        closeErrorBtn.addEventListener('click', hideError);
    });
    </script>
</body>
</html>












